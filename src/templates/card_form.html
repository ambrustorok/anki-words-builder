{% extends "base.html" %}

{% block content %}
{% set payload = form_payload | default({}) %}
{% set audio = audio_preferences | default({}) %}
{% set gen_disabled = generation_disabled | default(false) %}
{% set title = "Add cards to " + deck.name if mode == "create" else "Edit cards in " + deck.name %}

<article class="rounded-3xl border border-slate-200/80 bg-white p-6 shadow-2xl shadow-slate-200/50 transition dark:border-white/10 dark:bg-slate-900/50 dark:shadow-black/30">
    <div class="flex flex-col gap-4 border-b border-slate-200/70 pb-6 dark:border-white/5 lg:flex-row lg:items-center lg:justify-between">
        <div>
            <p class="text-xs uppercase tracking-[0.35em] text-slate-500 dark:text-slate-400">Deck · {{ deck.target_language }}</p>
            <h2 class="text-2xl font-semibold text-slate-900 dark:text-white">{{ title }}</h2>
            <p class="text-sm text-slate-500 dark:text-slate-400">Type the foreign phrase, then let the assistant draft translations, notes, examples, and pronunciation audio.</p>
        </div>
        {% if key_summary and key_summary.has_key %}
            <div class="rounded-2xl border border-emerald-400/40 bg-emerald-100 px-5 py-3 text-sm text-emerald-800 dark:border-emerald-400/30 dark:bg-emerald-400/10 dark:text-emerald-100">
                Using your OpenAI key ({{ key_summary.masked }}) for this session.
            </div>
        {% else %}
            <div class="rounded-2xl border border-amber-400/40 bg-amber-100 px-5 py-3 text-sm text-amber-800 dark:border-amber-400/30 dark:bg-amber-400/10 dark:text-amber-100">
                No personal OpenAI key stored. Add one on the <a class="underline" href="/profile">profile page</a> or continue with the shared key.
            </div>
        {% endif %}
    </div>

    {% if gen_disabled %}
        <p class="mt-4 rounded-2xl border border-amber-400/40 bg-amber-100 px-4 py-3 text-sm font-medium text-amber-800 dark:border-amber-400/30 dark:bg-amber-500/10 dark:text-amber-100">
            Add an OpenAI API key on your <a class="underline" href="/profile">profile</a> to enable field generation.
        </p>
    {% endif %}
    {% if error %}
        <p class="mt-4 rounded-2xl border border-red-400/40 bg-red-100 px-4 py-3 text-sm font-medium text-red-800 dark:border-red-400/30 dark:bg-red-500/10 dark:text-red-200">{{ error }}</p>
    {% endif %}
    {% if info %}
        <p class="mt-4 rounded-2xl border border-emerald-400/40 bg-emerald-100 px-4 py-3 text-sm font-medium text-emerald-800 dark:border-emerald-400/30 dark:bg-emerald-500/10 dark:text-emerald-200">{{ info }}</p>
    {% endif %}

    <form method="post" action="{{ form_action or '/cards' }}" class="mt-8 space-y-8">
        {% if mode == "create" %}
            <input type="hidden" name="deck_id" value="{{ deck.id }}">
        {% endif %}
        <input type="hidden" name="audio_preview_b64" value="{{ audio_preview_b64 }}">

        <div class="grid gap-8 lg:grid-cols-3">
            <section class="space-y-6 lg:col-span-2">
                {% if mode == "create" %}
                <div class="flex flex-col gap-2 rounded-2xl border border-slate-200/80 bg-white p-4 dark:border-white/10 dark:bg-white/5">
                    <div class="flex flex-col gap-2 lg:flex-row lg:items-center lg:justify-between">
                        <div>
                            <p class="text-sm font-semibold text-slate-900 dark:text-white">One-click generation</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Fill enabled fields{% if audio_enabled %} and audio{% endif %} after entering the foreign phrase. Deck settings control which fields allow AI generation.</p>
                        </div>
                        <button type="submit" name="submit_action" value="populate_all" class="inline-flex items-center justify-center rounded-full bg-brand px-4 py-2 text-sm font-semibold text-slate-900 transition hover:bg-sky-200 {% if gen_disabled %}!cursor-not-allowed opacity-50{% endif %}" {% if gen_disabled %}disabled{% endif %}>Generate all fields</button>
                    </div>
                </div>
                {% endif %}

                {% for field in deck.field_schema %}
                    <div class="rounded-2xl border border-slate-200/80 bg-slate-50 p-4 shadow-inner shadow-slate-200/80 dark:border-white/5 dark:bg-slate-900/60 dark:shadow-black/20">
                        <div class="flex items-baseline justify-between gap-4">
                            <label for="field-{{ field.key }}" class="text-sm font-semibold text-slate-900 dark:text-white">
                                {{ field.label }}
                                {% if field.required and field.key != "native_phrase" %}
                                    <span class="text-brand">*</span>
                                {% endif %}
                            </label>
                            {% if field.description %}
                                <span class="text-xs uppercase tracking-widest text-slate-500 dark:text-slate-400">{{ field.description }}</span>
                            {% endif %}
                        </div>
                        {% set field_required = field.required and field.key != "native_phrase" %}
                        <textarea
                            id="field-{{ field.key }}"
                            name="{{ field.key }}"
                            class="mt-3 w-full rounded-2xl border border-slate-200/80 bg-white px-4 py-3 text-sm text-slate-900 placeholder-slate-400 dark:border-white/10 dark:bg-slate-950/60 dark:text-white dark:placeholder-slate-500"
                            rows="{% if field.key == 'dictionary_entry' %}6{% elif field.key == 'example_sentence' %}4{% else %}3{% endif %}"
                            {% if field_required %}required{% endif %}
                        >{{ payload.get(field.key, '') | e }}</textarea>
                        {% if field.auto_generate %}
                            <div class="mt-3 flex flex-wrap gap-3 text-xs font-medium">
                                {% set regen_action = None %}
                                {% set regen_label = None %}
                                {% if field.key == "native_phrase" %}
                                    {% set regen_action = "regen_native_phrase" %}
                                    {% set regen_label = "Regenerate translation" %}
                                {% elif field.key == "dictionary_entry" %}
                                    {% set regen_action = "regen_dictionary_entry" %}
                                    {% set regen_label = "Regenerate dictionary entry" %}
                                {% elif field.key == "example_sentence" %}
                                    {% set regen_action = "regen_example_sentence" %}
                                    {% set regen_label = "Regenerate example sentence" %}
                                {% endif %}
                                {% if regen_action %}
                                    <button type="submit" name="submit_action" value="{{ regen_action }}" class="rounded-full border border-slate-300 px-3 py-1 text-slate-600 hover:border-brand hover:text-slate-900 dark:border-white/20 dark:text-slate-200 dark:hover:text-white {% if gen_disabled %}!cursor-not-allowed opacity-50{% endif %}" {% if gen_disabled %}disabled{% endif %}>{{ regen_label }}</button>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </section>

            <aside class="space-y-6">
                {% if audio_enabled %}
                    <section class="rounded-3xl border border-slate-200/80 bg-white p-5 text-sm dark:border-white/10 dark:bg-slate-900/60">
                        <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Pronunciation audio</h3>
                        <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Fill this field however you prefer: regenerate via OpenAI or paste an external link. Both options stay visible so you can switch instantly.</p>
                        <div class="mt-5 space-y-5">
                            <div class="rounded-2xl border border-slate-200/70 bg-white/70 p-4 dark:border-white/10 dark:bg-black/20">
                                <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Generate with OpenAI</p>
                                <label class="mt-2 block text-xs font-medium text-slate-500 dark:text-slate-400">
                                    Voice
                                    <select name="audio_voice" class="mt-2 w-full rounded-2xl border border-slate-200/80 bg-white px-3 py-2 text-sm text-slate-900 dark:border-white/10 dark:bg-slate-950/60 dark:text-white">
                                        {% for option in audio_voice_options %}
                                            {% set is_selected = (audio.voice == option) %}
                                            <option value="{{ option }}" {% if is_selected %}selected{% endif %}>
                                                {{ option | capitalize if option != "random" else "Random voice" }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </label>
                                <label class="mt-3 block text-xs font-medium text-slate-500 dark:text-slate-400">
                                    Instructions
                                    <textarea name="audio_instructions" rows="3" class="mt-2 w-full rounded-2xl border border-slate-200/80 bg-white px-3 py-2 text-sm text-slate-900 placeholder-slate-500 dark:border-white/10 dark:bg-slate-950/60 dark:text-white dark:placeholder-slate-500" placeholder="e.g. Speak in a cheerful, encouraging tone.">{{ audio.instructions | e }}</textarea>
                                </label>
                                <div class="mt-4 flex flex-wrap justify-end">
                                    <button type="submit" name="submit_action" value="regen_audio" class="rounded-full border border-slate-300 px-4 py-2 text-xs font-semibold text-slate-700 hover:border-brand hover:text-slate-900 dark:border-white/20 dark:text-white {% if gen_disabled %}!cursor-not-allowed opacity-50{% endif %}" {% if gen_disabled %}disabled{% endif %}>Regenerate audio</button>
                                </div>
                            </div>
                            <div class="rounded-2xl border border-dashed border-slate-300/80 p-4 dark:border-white/20">
                                <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Use audio link</p>
                                <label class="mt-2 block text-xs font-medium text-slate-500 dark:text-slate-400">
                                    URL
                                    <div class="mt-2 flex flex-col gap-3 sm:flex-row">
                                        <input type="url" name="audio_url" value="{{ audio_url | default('') }}" placeholder="https://example.com/audio.mp3" class="flex-1 rounded-2xl border border-slate-200/80 bg-white px-3 py-2 text-sm text-slate-900 placeholder-slate-400 focus:ring-2 focus:ring-brand dark:border-white/10 dark:bg-slate-950/60 dark:text-white dark:placeholder-slate-500">
                                        <button type="submit" name="submit_action" value="fetch_audio" class="rounded-full border border-slate-300 px-4 py-2 text-xs font-semibold text-slate-700 hover:border-brand hover:text-slate-900 dark:border-white/20 dark:text-white">Fetch audio</button>
                                    </div>
                                </label>
                                <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">We’ll download HTTP/HTTPS links, convert to MP3, and attach the result to this card.</p>
                            </div>
                            <div class="rounded-2xl border border-slate-200/80 bg-slate-50 p-3 dark:border-white/10 dark:bg-black/30">
                                {% if audio_preview_b64 %}
                                    <audio controls class="w-full" src="data:audio/mpeg;base64,{{ audio_preview_b64 }}"></audio>
                                {% else %}
                                    <p class="text-xs text-slate-500 dark:text-slate-400">No audio yet. Generate with AI or fetch from a link to preview it here.</p>
                                {% endif %}
                            </div>
                        </div>
                    </section>
                {% else %}
                    <section class="rounded-3xl border border-slate-200/80 bg-white p-5 dark:border-white/10 dark:bg-slate-900/60">
                        <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Pronunciation audio</h3>
                        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">Audio generation is disabled for this deck. Enable it from the <a class="underline" href="/decks/{{ deck.id }}/edit">deck settings</a> if you need narration.</p>
                    </section>
                {% endif %}
            </aside>
        </div>

        <section class="rounded-3xl border border-slate-200/80 bg-white p-5 dark:border-white/10 dark:bg-slate-900/60">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white">
                Directions to {{ 'generate' if mode == 'create' else 'keep' }}
            </h3>
            {% if mode == "create" %}
                <p class="text-xs text-slate-500 dark:text-slate-400">Forward cards show the foreign phrase on the front; backward cards flip to show the native phrase first.</p>
            {% else %}
                <p class="text-xs text-slate-500 dark:text-slate-400">Toggle which card directions you want to keep for this entry. Unchecked directions will be deleted.</p>
            {% endif %}
            <div class="mt-4 flex flex-col gap-3 text-sm">
                <label class="flex items-center gap-3">
                    <input type="checkbox" name="direction_forward" {% if not directions or 'forward' in directions %}checked{% endif %} class="h-4 w-4 rounded border-slate-300 bg-white text-brand focus:ring-brand dark:border-white/20 dark:bg-slate-900">
                    <span>Forward (front = foreign phrase, back = translation, example, dictionary, audio)</span>
                </label>
                <label class="flex items-center gap-3">
                    <input type="checkbox" name="direction_backward" {% if not directions or 'backward' in directions %}checked{% endif %} class="h-4 w-4 rounded border-slate-300 bg-white text-brand focus:ring-brand dark:border-white/20 dark:bg-slate-900">
                    <span>Backward (front = native phrase, back = foreign phrase plus supporting context)</span>
                </label>
            </div>
        </section>

        <div class="flex items-center justify-end">
            <button type="submit" name="submit_action" value="save" class="inline-flex items-center rounded-full bg-brand px-6 py-3 text-base font-semibold text-slate-900 transition hover:bg-sky-200">{{ submit_label }}</button>
        </div>
    </form>
</article>
{% endblock %}
